{% extends 'base.html' %}
{% block title %}Pagamentos — Admin{% endblock %}
{% block page_title %}<i class="bi bi-cash-coin me-1"></i>Pagamentos (Stripe){% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">

    <form class="row g-2 align-items-end mb-3" method="get">
      <div class="col-md-4">
        <label class="form-label small">E-mail (cliente)</label>
        <input class="form-control form-control-sm" name="email" value="{{ q_email }}">
      </div>
      <div class="col-md-3">
        <label class="form-label small">Status da fatura</label>
        <select class="form-select form-select-sm" name="status">
          <option value="">Todos</option>
          {% for s in statuses %}
          <option value="{{ s }}" {% if q_status==s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-5 text-end">
        <button class="btn btn-sm btn-primary"><i class="bi bi-search me-1"></i>Filtrar</button>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin_bp.admin_payments') }}">Limpar</a>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Plano</th>
            <th>Valor</th>
            <th>Status</th>
            <th>Invoice</th>
            <th>Subscr.</th>
            <th>PI / Charge</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in invoices %}
          {% set email = inv.customer.email if inv.customer else '' %}
          {% set price = inv.lines.data[0].price if inv.lines and inv.lines.data and inv.lines.data[0].price else None %}
          {% set product_name = price.nickname or (price.product.name if price and price.product and price.product.name else '') %}
          {% set amount = (inv.amount_paid or inv.amount_due or 0) / 100 %}
          {% set pi = inv.payment_intent %}
          <tr>
            <td>{{ (inv.created | int) | datetimeformat('%d/%m/%Y %H:%M') if inv.created else '-' }}</td>
            <td>{{ email or '-' }}</td>
            <td>{{ product_name or '-' }}</td>
            <td>R$ {{ '%.2f'|format(amount) }}</td>
            <td>
              <span class="badge text-bg-{{ 'success' if inv.status=='paid' else 'secondary' }}">{{ inv.status }}</span>
            </td>
            <td class="text-muted small">{{ inv.number or inv.id }}</td>
            <td class="text-muted small">{{ inv.subscription.id if inv.subscription else '-' }}</td>
            <td class="text-muted small">
              {% if pi %}
                {{ pi.id }}
                {% if pi.latest_charge %}<div class="small">charge: {{ pi.latest_charge }}</div>{% endif %}
              {% else %}-{% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <form method="post" action="{{ url_for('admin_bp.admin_payment_validate', invoice_id=inv.id) }}">
                  <button class="btn btn-outline-secondary" title="Validar/Sync">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                </form>
                {% if inv.status == 'paid' %}
                <form method="post" action="{{ url_for('admin_bp.admin_payment_refund', invoice_id=inv.id) }}"
                      onsubmit="return confirm('Confirmar reembolso?')">
                  <button class="btn btn-outline-danger" title="Reembolsar">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                </form>
                {% endif %}
                {% if inv.subscription %}
                <form method="post" action="{{ url_for('admin_bp.admin_subscription_cancel', sub_id=inv.subscription.id) }}"
                      onsubmit="return confirm('Cancelar assinatura?')">
                  <input type="hidden" name="at_period_end" value="">
                  <button class="btn btn-outline-warning" title="Cancelar assinatura">
                    <i class="bi bi-x-circle"></i>
                  </button>
                </form>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
          {% if not invoices %}
          <tr><td colspan="9" class="text-center text-muted">Sem registros Stripe para o filtro atual.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between">
      <div class="small text-muted">
        {% if q_email %}Filtro por e-mail: <code>{{ q_email }}</code>{% endif %}
        {% if q_status %} &middot; Status: <code>{{ q_status }}</code>{% endif %}
      </div>
      <div class="btn-group">
        <a class="btn btn-sm btn-outline-secondary {% if not prev_cursor %}disabled{% endif %}"
           href="{{ url_for('admin_bp.admin_payments', ending_before=prev_cursor, email=q_email, status=q_status) }}">
          « Anteriores
        </a>
        <a class="btn btn-sm btn-outline-secondary {% if not has_more %}disabled{% endif %}"
           href="{{ url_for('admin_bp.admin_payments', starting_after=next_cursor, email=q_email, status=q_status) }}">
          Próximos »
        </a>
      </div>
    </div>

  </div>
</div>
{% endblock %}
