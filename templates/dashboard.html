{% extends 'base.html' %}
{% block title %}Dashboard — ZFM Calculator{% endblock %}
{% block page_title %}<i class="bi bi-speedometer2 me-1"></i>Dashboard{% endblock %}
{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-6 col-lg-3"><div class="stat"><div class="label">Usuários</div><div class="value">{{ stats.users }}</div></div></div>
  <div class="col-6 col-lg-3"><div class="stat"><div class="label">NF-e processadas (mês)</div><div class="value">{{ stats.nfes_month }}</div></div></div>
  <div class="col-6 col-lg-3"><div class="stat"><div class="label">MRR (R$/mês)</div><div class="value">{{ '%.2f'|format(stats.mrr) }}</div></div></div>
  <div class="col-6 col-lg-3"><div class="stat"><div class="label">Armazenamento</div><div class="value">{{ stats.storage }}</div></div></div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-8">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="mb-3">NF-e processadas — últimos 7 dias</h6>
        <canvas id="chartNfe" height="110"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h6 class="mb-3">MRR por plano (exemplo)</h6>
        <canvas id="chartMRR" height="110"></canvas>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block body_extra %}
<script>
  // Dados vindos do backend (simples)
  const lastWeek = {{ stats.last_week|tojson }};
  const mrrByPlan = {{ stats.mrr_by_plan|tojson if stats.mrr_by_plan is defined else {'Basic':5000,'Pro':9000,'Ent':349.9}|tojson }};
  // Linha — NF-e / dia
  new Chart(document.getElementById('chartNfe'), {
    type: 'line',
    data: {
      labels: ['D-6','D-5','D-4','D-3','D-2','D-1','Hoje'],
      datasets: [{ label: 'NF-e', data: lastWeek, tension:.3 }]
    },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
    }
  });
  // Barras — MRR por plano
  const labels = Object.keys(mrrByPlan);
  const values = Object.values(mrrByPlan);
  new Chart(document.getElementById('chartMRR'), {
    type: 'bar',
    data: { labels, datasets:[{ label:'R$/mês', data: values }]},
    options: {
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } }
    }
  });
</script>
{% endblock %}
