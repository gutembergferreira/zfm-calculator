<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>NF-e — Pré-visualização</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <style>
        .chip { font-size: .75rem; padding: .25rem .5rem; border-radius: 999px; background:#eef2ff; color:#3b5bdb; }
        .label { color:#6c757d; font-size:.85rem; }
        .kv { margin-bottom: .25rem; }
        .kv .k { width: 160px; color:#6c757d; }
        .kv .v { font-weight: 500; }
        .muted { color:#6c757d; }
        .table thead th { white-space: nowrap; }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="row">
        <div class="col-lg-12 mx-auto">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h5 mb-0">Captura e Auditoria de XML</h1>
                <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">Voltar</a>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="chip">XML</span>
                        <span class="chip">DANFE</span>
                        <span class="chip" style="background:#e6fcf5;color:#0c8599">Conferir</span>
                        <span class="chip" style="background:#fff5f5;color:#c92a2a">Não conforme</span>
                    </div>

                    <div class="row g-3">
                        <div class="col-lg-9">
                            <div class="kv d-flex"><div class="k">Chave da Nota Fiscal:</div><div class="v">{{ head.chave or "-" }}</div></div>
                            <div class="kv d-flex"><div class="k">Emitente:</div><div class="v">{{ head.emitente_nome }} - {{ head.emitente_cnpj }}</div></div>
                            <div class="kv d-flex"><div class="k">Destinatário:</div><div class="v">{{ head.dest_nome }} - {{ head.dest_cnpj }}</div></div>
                            <div class="kv d-flex"><div class="k">Número / Série:</div><div class="v">{{ head.numero }} / {{ head.serie }}</div></div>
                        </div>
                        <div class="col-lg-3">
                            <div class="text-end">
                                <div class="label">Data Emissão</div>
                                <span class="chip" style="background:#ffe3e3;color:#d9480f">{{ head.dhEmi or "-" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h2 class="h6">Movimentação</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="kv d-flex"><div class="k">Origem:</div><div class="v">→ {{ head.uf_origem or "-" }}</div></div>
                        </div>
                        <div class="col-md-6">
                            <div class="kv d-flex"><div class="k">Destino:</div><div class="v">↗ {{ head.uf_destino or "-" }}</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h6 mb-0">Produtos</h2>
                        <form method="post" action="{{ url_for('calcular') }}" class="d-flex gap-2">
                            <input type="hidden" name="xml_b64" value="{{ xml_b64 }}">
                            <input type="hidden" name="usar_multiplicador" value="on">
                            <input type="text" class="form-control form-control-sm" name="uf_origem" value="{{ uf_origem }}" style="max-width:80px" title="UF Origem">
                            <input type="text" class="form-control form-control-sm" name="uf_destino" value="{{ uf_destino }}" style="max-width:80px" title="UF Destino">
                            <button class="btn btn-primary btn-sm" type="submit">Calcular ST</button>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>Código</th>
                                <th>Descrição</th>
                                <th>NCM</th>
                                <th>CST</th>
                                <th>CFOP</th>
                                <th>Unid.</th>
                                <th class="text-end">Vlr Unitário</th>
                                <th class="text-end">Qtde</th>
                                <th class="text-end">Vlr Bruto</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for it in itens %}
                            <tr>
                                <td>{{ it.cProd }}</td>
                                <td class="text-truncate" style="max-width:420px">{{ it.xProd }}</td>
                                <td>{{ it.ncm }}</td>
                                <td>{{ it.cst }}</td>
                                <td>{{ it.cfop }}</td>
                                <td>{{ it.uCom or it.uTrib or "-" }}</td>
                                <td class="text-end">{{ "%.4f"|format(it.vUnCom) }}</td>
                                <td class="text-end">{{ "%.4f"|format(it.qCom) }}</td>
                                <td class="text-end">{{ "%.2f"|format(it.vProd) }}</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                            <div class="small text-muted px-3 pb-2">Itens: {{ itens|length }}</div>
                        </table>
                    </div>

                    <div class="muted small">Itens: {{ produtos|length }}</div>
                </div>
            </div>

            <!-- Se quiser, aqui dá pra adicionar blocos de Eventos / Autorização / Totais -->
        </div>
    </div>
</div>
</body>
</html>
