{% extends 'base.html' %}
{% block title %}NF-e — Pré-visualização{% endblock %}
{% block page_title %}<i class="bi bi-speedometer2 me-1"></i>NF-e — Pré-visualização{% endblock %}
{% block head_extra %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background: #f6f7fb; }
    .chip { font-size:.75rem; padding:.25rem .6rem; border-radius:999px; background:#eef2ff; color:#3b5bdb; }
    .chip-green { background:#e6fcf5; color:#0c8599; }
    .chip-red { background:#fff5f5; color:#c92a2a; }
    .kv .k { width: 200px; color:#6c757d; }
    .kv .v { font-weight: 600; }
    .section-title { font-size:.9rem; color:#6c757d; text-transform:uppercase; letter-spacing:.05em; }
    .stat { border:1px solid #eef0f4; border-radius:.75rem; padding:1rem; background:#fff; }
    .stat .label { font-size:.8rem; color:#6c757d; }
    .stat .value { font-weight:700; font-size:1.05rem; }
    .code { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .table thead th { white-space: nowrap; position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
    .row-detail { background:#fafbff; }
    .truncate { max-width: 520px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .toolbar { border: 1px solid #e9ecef; background:#fff; border-radius:.75rem; padding:.5rem .75rem; }
    .btn-status.active { box-shadow: inset 0 0 0 999px rgba(0,0,0,.06); }
  </style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">

  <!-- Top bar -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('files.list_files') }}"><i class="bi bi-arrow-left"></i> Voltar</a>
        <form id="form-calc" method="post" action="{{ url_for('nfe.calcular') }}" class="d-inline">
            <input type="hidden" name="xml_b64" value="{{ xml_b64 }}">
            <button type="button" id="btnCalcular" class="btn btn-primary">
                <i class="bi bi-cpu"></i> Calcular ST
            </button>
        </form>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="chip"><i class="bi bi-filetype-xml me-1"></i>XML</span>
      <span class="chip"><i class="bi bi-file-earmark-text me-1"></i>DANFE</span>
      <div class="btn-group btn-group-sm" role="group" aria-label="status">
        <button id="btnConferir" class="btn btn-outline-success btn-status"><i class="bi bi-shield-check me-1"></i>Conferir</button>
        <button id="btnNaoConf"  class="btn btn-outline-danger  btn-status"><i class="bi bi-x-octagon me-1"></i>Não conforme</button>
      </div>
    </div>
  </div>

  <!-- Identificação -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="section-title mb-2">Identificação</div>
          <div class="kv d-flex flex-wrap align-items-center mb-1">
            <div class="k">Chave da Nota Fiscal</div><div class="v code">{{ head.chave or "-" }}</div>
          </div>
          <div class="kv d-flex flex-wrap align-items-center mb-1">
            <div class="k">Modelo / Série / Número</div><div class="v">{{ head.modelo }} / {{ head.serie }} / {{ head.numero }}</div>
          </div>
          <div class="kv d-flex flex-wrap align-items-center">
            <div class="k">Emissão / Saída</div><div class="v">{{ head.dhEmi or "-" }} / {{ head.dhSaiEnt or "-" }}</div>
          </div>
          <div class="kv d-flex flex-wrap align-items-center mt-2">
            <div class="k">Natureza da Operação</div><div class="v">{{ head.natOp or "-" }}</div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="section-title mb-2">Movimentação</div>
          <div class="kv d-flex"><div class="k">Origem</div><div class="v">→ {{ head.uf_origem or "-" }}</div></div>
          <div class="kv d-flex"><div class="k">Destino</div><div class="v">↗ {{ head.uf_destino or "-" }}</div></div>
        </div>
      </div>

      <!-- Emitente / Destinatário -->
      <div class="mt-3">
        <div class="accordion" id="acc-partes">
          <div class="accordion-item">
            <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#emitente"><i class="bi bi-building me-2"></i> Emitente</button></h2>
            <div id="emitente" class="accordion-collapse collapse show" data-bs-parent="#acc-partes">
              <div class="accordion-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="kv d-flex"><div class="k">Nome</div><div class="v">{{ head.emitente_nome or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">CNPJ</div><div class="v">{{ head.emitente_cnpj or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">IE</div><div class="v">{{ head.emitente_ie or "-" }}</div></div>
                  </div>
                  <div class="col-md-6">
                    <div class="kv d-flex"><div class="k">Endereço</div><div class="v">{{ head.emitente_endereco or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">Município / UF</div><div class="v">{{ head.emitente_municipio or "-" }} / {{ head.emitente_uf or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">CEP</div><div class="v">{{ head.emitente_cep or "-" }}</div></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#destinatario"><i class="bi bi-geo-alt me-2"></i> Destinatário</button></h2>
            <div id="destinatario" class="accordion-collapse collapse" data-bs-parent="#acc-partes">
              <div class="accordion-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="kv d-flex"><div class="k">Nome</div><div class="v">{{ head.dest_nome or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">CNPJ</div><div class="v">{{ head.dest_cnpj or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">IE / ISUF</div><div class="v">{{ head.dest_ie or "-" }} {% if head.dest_isuf %}/ {{ head.dest_isuf }}{% endif %}</div></div>
                  </div>
                  <div class="col-md-6">
                    <div class="kv d-flex"><div class="k">Endereço</div><div class="v">{{ head.dest_endereco or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">Município / UF</div><div class="v">{{ head.dest_municipio or "-" }} / {{ head.dest_uf or "-" }}</div></div>
                    <div class="kv d-flex"><div class="k">CEP</div><div class="v">{{ head.dest_cep or "-" }}</div></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div><!-- /accordion -->
      </div>
    </div>
  </div>

  <!-- Abas -->
  <div class="toolbar mb-3">
    <ul class="nav nav-pills" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-produtos" type="button" role="tab"><i class="bi bi-box-seam me-1"></i>Produtos</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-totais" type="button" role="tab"><i class="bi bi-cash-coin me-1"></i>Totais</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-obs" type="button" role="tab"><i class="bi bi-card-text me-1"></i>Observações</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-xml" type="button" role="tab"><i class="bi bi-code-slash me-1"></i>XML bruto</button></li>
    </ul>
  </div>

  <div class="tab-content">

    <!-- Produtos (idêntico ao que já te enviei) -->
    <div class="tab-pane fade show active" id="tab-produtos" role="tabpanel">
      <!-- … (mantenha aqui a tabela de produtos do arquivo anterior) … -->
      {% set _ = 0 %}
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
            <div class="text-muted">Itens: <strong>{{ itens|length }}</strong></div>
            <div class="input-group input-group-sm" style="max-width:360px">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="filtro" type="text" class="form-control" placeholder="Filtrar por código, descrição, NCM, CFOP...">
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:34px;"></th>
                  <th>Código</th><th>Descrição</th><th>EAN</th><th>NCM</th><th>CEST</th><th>CST</th><th>CFOP</th><th>Un.</th>
                  <th class="text-end">Vlr Unit.</th><th class="text-end">Qtde</th><th class="text-end">Vlr Bruto</th>
                  <th class="text-end">Frete</th><th class="text-end">ICMS Deson.</th>
                </tr>
              </thead>
              <tbody id="tbody-itens">
                {% for it in itens %}
                  {% set key = 'row' ~ loop.index %}
                  <tr data-filter="{{ (it.cProd ~ ' ' ~ it.xProd ~ ' ' ~ it.ncm ~ ' ' ~ it.cfop)|lower }}">
                    <td><button class="btn btn-sm btn-link text-decoration-none" data-bs-toggle="collapse" data-bs-target="#{{ key }}"><i class="bi bi-caret-down-square"></i></button></td>
                    <td class="code">{{ it.cProd }}</td>
                    <td class="truncate" title="{{ it.xProd }}">{{ it.xProd }}</td>
                    <td>{{ it.cEAN or it.cEANTrib or '-' }}</td>
                    <td>{{ it.ncm }}</td>
                    <td>{{ it.cest or '-' }}</td>
                    <td>{{ it.cst }}</td>
                    <td>{{ it.cfop }}</td>
                    <td>{{ it.uCom or it.uTrib or '-' }}</td>
                    <td class="text-end">{{ '%.4f'|format(it.vUnCom) }}</td>
                    <td class="text-end">{{ '%.4f'|format(it.qCom) }}</td>
                    <td class="text-end">{{ '%.2f'|format(it.vProd) }}</td>
                    <td class="text-end">{{ '%.2f'|format(it.vFrete or 0) }}</td>
                    <td class="text-end">{{ '%.2f'|format(it.vICMSDeson or 0) }}</td>
                  </tr>
                  <tr id="{{ key }}" class="collapse row-detail">
                    <td></td>
                    <td colspan="13">
                      <div class="row g-3">
                        <div class="col-6 col-md-3"><div class="stat"><div class="label">IPI</div><div class="value">R$ {{ '%.2f'|format(it.vIPI or 0) }}</div></div></div>
                        <div class="col-6 col-md-3"><div class="stat"><div class="label">Outras Desp.</div><div class="value">R$ {{ '%.2f'|format(it.vOutro or 0) }}</div></div></div>
                        <div class="col-6 col-md-3"><div class="stat"><div class="label">Frete rateado</div><div class="value">R$ {{ '%.2f'|format(it.vFrete or 0) }}</div></div></div>
                        <div class="col-6 col-md-3"><div class="stat"><div class="label">ICMS Deson.</div><div class="value">R$ {{ '%.2f'|format(it.vICMSDeson or 0) }}</div></div></div>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Totais -->
    <div class="tab-pane fade" id="tab-totais" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6 col-md-3"><div class="stat"><div class="label">Produtos</div><div class="value">R$ {{ '%.2f'|format(totais.get('vProd',0)) }}</div></div></div>
            <div class="col-6 col-md-3"><div class="stat"><div class="label">Frete</div><div class="value">R$ {{ '%.2f'|format(totais.get('vFrete',0)) }}</div></div></div>
            <div class="col-6 col-md-3"><div class="stat"><div class="label">IPI</div><div class="value">R$ {{ '%.2f'|format(totais.get('vIPI',0)) }}</div></div></div>
            <div class="col-6 col-md-3"><div class="stat"><div class="label">Descontos</div><div class="value">R$ {{ '%.2f'|format(totais.get('vDesc',0)) }}</div></div></div>
            <div class="col-6 col-md-3"><div class="stat"><div class="label">Outros</div><div class="value">R$ {{ '%.2f'|format(totais.get('vOutro',0)) }}</div></div></div>
            <div class="col-6 col-md-3"><div class="stat"><div class="label">ICMS Desonerado</div><div class="value">R$ {{ '%.2f'|format(totais.get('vICMSDeson',0)) }}</div></div></div>
            <div class="col-6 col-md-3"><div class="stat"><div class="label">Valor Total NF</div><div class="value">R$ {{ '%.2f'|format(totais.get('vNF',0)) }}</div></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Observações -->
    <div class="tab-pane fade" id="tab-obs" role="tabpanel">
      <div class="card shadow-sm"><div class="card-body">
        {% if inf_cpl %}<pre class="mb-0" style="white-space:pre-wrap">{{ inf_cpl }}</pre>
        {% else %}<div class="text-muted">Sem observações adicionais.</div>{% endif %}
      </div></div>
    </div>

    <!-- XML bruto -->
    <div class="tab-pane fade" id="tab-xml" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title mb-0">XML bruto</div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnCopyXml"><i class="bi bi-clipboard"></i></button>
              <a id="btnDownloadXml" class="btn btn-outline-primary btn-sm" download="nfe.xml"><i class="bi bi-download me-1"></i>Baixar</a>
            </div>
          </div>
          <pre id="xmlRaw" class="bg-light p-3 rounded small" style="white-space:pre; max-height:60vh; overflow:auto"></pre>
          <input type="hidden" id="xml_b64" value="{{ xml_b64 }}">
        </div>
      </div>
    </div>

  </div><!-- /tab-content -->
</div><!-- /container -->
<div class="modal fade" id="calcModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2"></i>Processando XML</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="progress" style="height:22px">
          <div id="calcBar" class="progress-bar progress-bar-striped progress-bar-animated"
               role="progressbar" style="width: 10%">10%</div>
        </div>
        <p class="mt-3 mb-0 text-muted small" id="calcHint">Iniciando cálculo…</p>
      </div>
    </div>
  </div>
</div>

<div id="calcResult"></div>
{% endblock %}
{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const btn = document.getElementById('btnCalcular');
  const form = document.getElementById('form-calc');
  const modal = new bootstrap.Modal(document.getElementById('calcModal'));
  const bar = document.getElementById('calcBar');
  const hint = document.getElementById('calcHint');
  const result = document.getElementById('calcResult');

  function setBar(p, text){
    p = Math.max(5, Math.min(100, p|0));
    bar.style.width = p + '%';
    bar.textContent = p + '%';
    if (text) hint.textContent = text;
  }

  btn?.addEventListener('click', async () => {
    // mostra modal + animação incremental até ~90%
    modal.show();
    let p = 10;
    const timer = setInterval(() => {
      if (p < 90) { p += Math.random()*7; setBar(p, 'Calculando…'); }
    }, 250);

    try {
      const formData = new FormData(form);
      const resp = await fetch(form.action, { method: 'POST', body: formData });
      const html = await resp.text();

      clearInterval(timer);
      setBar(100, 'Finalizando…');

      // estratégia 1: renderiza o resultado abaixo do preview
      // result.innerHTML = html;
      // estratégia 2 (alternativa): abrir em nova aba
      // const w = window.open('about:blank','_blank');
      // w.document.open(); w.document.write(html); w.document.close();
        document.open();
        document.write(html);
        document.close();
      setTimeout(()=> modal.hide(), 600);
    } catch (e) {
      clearInterval(timer);
      setBar(100, 'Falhou.');
      hint.textContent = 'Ocorreu um erro durante o cálculo.';
      console.error(e);
    }
  });
})();
</script>
<script>
  // Filtro
  (function(){
    const filtro = document.getElementById('filtro');
    const tbody = document.getElementById('tbody-itens');
    if (!filtro || !tbody) return;
    filtro.addEventListener('input', () => {
      const q = filtro.value.trim().toLowerCase();
      for (const tr of tbody.querySelectorAll('tr')) {
        if (!tr.dataset.filter) continue;
        const ok = tr.dataset.filter.includes(q);
        tr.style.display = ok ? '' : 'none';
        const det = tr.nextElementSibling;
        if (det && det.classList.contains('row-detail')) det.style.display = tr.style.display;
      }
    });
  })();

  // XML pretty + copiar + baixar
  (function(){
    const b64 = document.getElementById('xml_b64')?.value || '';
    if (!b64) return;
    let xml = ''; try { xml = atob(b64); } catch(e) { return; }
    function formatXml(s){
      const PAD='  ';
      s=s.replace(/>\s*</g,'><'); s=s.replace(/</g,'\n<');
      const out=[], lines=s.trim().split('\n'); let ind=0;
      for(let ln of lines){ if(/^<\/.+>/.test(ln)) ind=Math.max(ind-1,0);
        out.push(PAD.repeat(ind)+ln);
        if(/^<[^!?].*[^\/]>$/.test(ln) && !/<\/.+>$/.test(ln)) ind++; }
      return out.join('\n');
    }
    const pretty=formatXml(xml);
    const pre=document.getElementById('xmlRaw'); pre.textContent=pretty;
    const blob=new Blob([xml],{type:'application/xml'}), url=URL.createObjectURL(blob);
    document.getElementById('btnDownloadXml').href=url;
    document.getElementById('btnCopyXml')?.addEventListener('click',async()=>{try{await navigator.clipboard.writeText(pretty);}catch(e){}});
  })();

  // Status (Conferir/Não conforme) → localStorage pela chave
  (function(){
    const chave="{{ head.chave or '' }}"; if(!chave) return;
    const KEY='nf_status_'+chave, bC=document.getElementById('btnConferir'), bN=document.getElementById('btnNaoConf');
    function render(s){ bC.classList.toggle('active', s==='conferir'); bN.classList.toggle('active', s==='nao_conforme'); }
    let s=localStorage.getItem(KEY)||''; render(s);
    bC.addEventListener('click',()=>{ s=(s==='conferir')?'':('conferir'); localStorage.setItem(KEY,s); render(s); });
    bN.addEventListener('click',()=>{ s=(s==='nao_conforme')?'':('nao_conforme'); localStorage.setItem(KEY,s); render(s); });
  })();
</script>
{% endblock %}
